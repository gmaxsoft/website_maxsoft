---
import { SEO } from "astro-seo";
import Preloader from "../components/Preloader.astro";
import Menu from "../components/Menu.astro";
import Footer from "../components/Footer.astro";
import HiddenElements from "../components/HiddenElements.astro";
import Seolink from "../components/Seolink.astro"; 
import pl from "../i18n/pl.json";
import en from "../i18n/en.json";

const translations = { pl, en };
export async function getStaticPaths() {
  return [
    { params: { lang: "pl" } }, // Strona dla języka polskiego
    { params: { lang: "en" } }, // Strona dla języka angielskiego
  ];
}

const { lang } = Astro.params as { lang: "pl" | "en" };
const langPrefix = `/${lang}`;
const content = translations[lang]?.index || translations.pl.index;
const contentFooter = translations[lang].footer;
const contentMenu = translations[lang].menu;
const contentPreloader = translations[lang].preloader;

const {
  canonical,
  title = content.title, // Tytuł strony (np. z JSON)
  description = content.description, // Opis strony (np. z JSON)
  currentLocale = lang, // Język strony
  ogImage = "/img/default-og.webp", // Obrazek OG
} = Astro.props;

const finalCanonical = canonical || (lang === 'pl' ? `https://www.maxsoft.pl/` : `https://www.maxsoft.pl${Astro.url.pathname}`);

const companyName = "MAXSOFT.PL";
const mainWebsite = "https://www.maxsoft.pl";
const mainLogo = `${mainWebsite}/img/logo-czarne.png`; // Upewnij się, że masz logo!

// Dane dla obu lokalizacji
const locations = [
  {
    name: "MAXSOFT Lubrza (Biuro Główne)",
    address: {
      streetAddress: "Nowa Wioska 39",
      addressLocality: "Lubrza",
      postalCode: "66-218",
      addressCountry: "PL",
    },
    telephone: "+48791821908",
    isPrimary: true, // Wskażemy, która jest główna
  },
  {
    name: "MAXSOFT Zielona Góra (Oddział)",
    address: {
      streetAddress: "ul. Prosta 45A",
      addressLocality: "Zielona Góra",
      postalCode: "65-463",
      addressCountry: "PL",
    },
    telephone: "+48453645286",
    isPrimary: false,
  },
];

// Generowanie obiektów LocalBusiness dla każdej lokalizacji
const businessSchemas = locations.map((loc) => ({
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  // Użyj BusinessType, np. SoftwareCompany, WebDesign, itp.
  // Zobacz listę typów LocalBusiness na Schema.org
  name: loc.name,
  url: mainWebsite,
  image: mainLogo,
  address: {
    "@type": "PostalAddress",
    ...loc.address,
  },
  telephone: loc.telephone,
  hasMap: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${loc.address.streetAddress}, ${loc.address.addressLocality}`)}`, // Link do mapy

  // Wskazanie na główną organizację
  parentOrganization: {
    "@type": "Organization",
    name: companyName,
    url: mainWebsite,
  },
  // Opcjonalne: Ustalenie, która jest główną lokalizacją
  ...(loc.isPrimary ? { branchOf: mainWebsite } : {}),
}));

// Generowanie głównego schematu Organization
const mainOrganizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: companyName,
  url: mainWebsite,
  logo: mainLogo,
  // Używamy subOrganization, aby połączyć ją z oddziałami LocalBusiness
  subOrganization: businessSchemas.map((schema) => ({
    "@type": "LocalBusiness", // LocalBusiness jest podtypem Organization, więc działa
    name: schema.name,
    address: schema.address,
    telephone: schema.telephone,
  })),
};

// Połącz schematy w jeden array
const allSchemas = [mainOrganizationSchema, ...businessSchemas];
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <SEO
      title={title}
      description={description}
      canonical={finalCanonical}
      openGraph={{
        basic: {
          title: title,
          type: "website",
          image: ogImage,
          url: finalCanonical,
        },
        // ...
      }}
    />
    <link rel="alternate" hreflang="pl" href="https://maxsoft.pl/" />
    <link rel="alternate" hreflang="en" href="https://maxsoft.pl/en/" />
    <link rel="alternate" hreflang="x-default" href="https://maxsoft.pl/" />
    <script
      type="application/ld+json"
      set:html={JSON.stringify(allSchemas, null, 2)}
    />
  </head>
  <body>
    <div class="mil-wrapper" id="top">
      <Preloader data={contentPreloader} langPrefix={langPrefix} />
      <Menu data={contentMenu} langPrefix={langPrefix} lang={lang} />
      <div class="mil-curtain"></div>

      <div class="mil-frame">
        <div class="mil-frame-top mil-logo-fixed">
          <a href={langPrefix} class="mil-logo">Maxsoft</a>

          <div class="mil-lang-switch">
                <a href="/pl/" class:list={["mil-lang-flag", lang === 'pl' ? 'mil-active' : '']}>PL</a>
                <a href="/en/" class:list={["mil-lang-flag", lang === 'en' ? 'mil-active' : '']}>EN</a>
          </div>

          <div class="mil-menu-btn">
            <span></span>
          </div>
        </div>
        <div class="mil-frame-bottom">
          <div class="mil-current-page"></div>
          <div class="mil-back-to-top">
            <a href="#top" class="mil-link mil-dark mil-arrow-place">
              <span>{content.softtxt17}</span>
            </a>
          </div>
        </div>
      </div>
      <div class="mil-content">
        <div class="mil-main-transition">
          <slot />
          <Footer data={contentFooter} langPrefix={langPrefix} />
          <HiddenElements />
          <Seolink />
        </div>
      </div>
    </div>

    <script>
      import "../scripts/main.js";
    </script>
  </body>
</html>

<style lang="scss" is:global>
  @import url("../assets/styles/style.scss");
</style>
